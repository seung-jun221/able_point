<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>프로필 - 포인트 뱅크</title>

    <!-- Supabase & API -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>

    <!-- 스타일시트 (순서 중요!) -->
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/student.css" />
    <link rel="stylesheet" href="../assets/css/navigation.css" />
    <!-- 통일된 네비게이션 -->
    <link rel="stylesheet" href="../assets/css/profile.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="with-both-nav">
    <!-- 상단 헤더 + 하단 네비 모두 있음 -->

    <!-- 상단 헤더 (통일된 구조) -->
    <div class="app-header">
      <div class="header-user">
        <div class="header-avatar">
          <div class="header-avatar-inner" id="headerAvatar">🦁</div>
        </div>
        <div class="header-name" id="headerName">학생 이름</div>
      </div>
      <div class="header-spacer"></div>
      <div class="header-actions">
        <div class="header-points" onclick="location.href='history.html'">
          <span class="header-points-icon">P</span>
          <span class="header-points-value" id="headerTotalPoints">0P</span>
        </div>
        <div class="header-notification" onclick="handleNotificationClick()">
          <span class="notification-icon">🔔</span>
          <span class="notification-badge"></span>
        </div>
      </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="profile-container">
      <!-- 메인 프로필 카드 -->
      <div class="profile-main-card">
        <div class="avatar-section">
          <div class="profile-avatar" id="profileAvatar">
            <span id="avatarEmoji">🦁</span>
          </div>
          <button class="avatar-change-btn" onclick="showAvatarModal()">
            변경
          </button>
        </div>

        <div class="profile-name" id="profileName">학생 이름</div>

        <div class="profile-badges">
          <span class="level-badge" id="profileLevel">🌱 새싹</span>
        </div>

        <!-- 레벨 진행률 -->
        <div class="level-progress">
          <div class="progress-info">
            <div class="current-points-display">
              <span class="points-label">현재 포인트</span>
              <span class="points-value" id="currentTotalPoints">0P</span>
            </div>
            <div class="next-level-info">
              <span class="next-label">다음 레벨까지</span>
              <span class="next-value" id="pointsToNext">1,000P</span>
            </div>
          </div>
          <div class="progress-bar-container">
            <div
              class="progress-bar-fill"
              id="levelProgress"
              style="width: 0%"
            ></div>
          </div>
          <div class="progress-text">
            <span id="progressDisplay">0 / 1,000P</span>
            <span id="progressPercentage">0%</span>
          </div>
          <div class="next-level-preview" id="nextLevelPreview">
            다음: 🌿 새싹
          </div>
        </div>
      </div>

      <!-- 통계 카드 -->
      <div class="stats-card">
        <div class="section-title">
          <span class="title-text">📊 나의 기록</span>
          <span class="title-badge">MY STATS</span>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-icon">💰</span>
            <div class="stat-info">
              <div class="stat-label">총 포인트</div>
              <div class="stat-value" id="totalPointsStat">0P</div>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">📈</span>
            <div class="stat-info">
              <div class="stat-label">이번달</div>
              <div class="stat-value positive" id="monthlyPointsStat">+0P</div>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">🏆</span>
            <div class="stat-info">
              <div class="stat-label">랭킹</div>
              <div class="stat-value" id="rankingStat">-</div>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">📅</span>
            <div class="stat-info">
              <div class="stat-label">출석</div>
              <div class="stat-value" id="attendanceStat">0일</div>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">🏦</span>
            <div class="stat-info">
              <div class="stat-label">저축</div>
              <div class="stat-value" id="savingsStat">0P</div>
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-icon">💝</span>
            <div class="stat-info">
              <div class="stat-label">기부</div>
              <div class="stat-value" id="donationStat">0P</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 업적/배지 카드 -->
      <div class="achievement-card">
        <div class="section-title">
          <span class="title-text">🏅 획득한 배지</span>
          <span class="title-badge" id="badgeCount">
            <span id="unlockedCount">0</span>/<span id="totalBadges">20</span>
          </span>
        </div>
        <div class="achievement-grid" id="achievementGrid">
          <!-- 배지들이 동적으로 생성됨 -->
        </div>
        <!-- 컬렉션 진행 상황이 여기에 추가됨 -->
      </div>

      <!-- 활동 차트 -->
      <div class="activity-card">
        <div class="section-title">
          <span class="title-text">📈 주간 활동</span>
          <span class="title-badge">WEEKLY</span>
        </div>
        <div class="chart-container">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <!-- 설정 카드 -->
      <div class="settings-card">
        <div class="section-title">
          <span class="title-text">⚙️ 설정</span>
        </div>
        <div class="settings-list">
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-title">알림</span>
              <span class="setting-desc">포인트 획득 시 알림</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notificationToggle" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-title">다크모드</span>
              <span class="setting-desc">어두운 테마 사용</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle" />
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-item" onclick="changePassword()">
            <div class="setting-info">
              <span class="setting-title">비밀번호 변경</span>
              <span class="setting-desc">계정 보안 설정</span>
            </div>
            <span class="setting-arrow">›</span>
          </div>
          <div class="setting-item" onclick="showDataExport()">
            <div class="setting-info">
              <span class="setting-title">데이터 내보내기</span>
              <span class="setting-desc">내 활동 기록 다운로드</span>
            </div>
            <span class="setting-arrow">›</span>
          </div>
          <div class="setting-item" onclick="logout()">
            <div class="setting-info">
              <span class="setting-title">로그아웃</span>
              <span class="setting-desc">안전하게 로그아웃</span>
            </div>
            <span class="setting-arrow">›</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 네비게이션 (통일된 구조) -->
    <nav class="app-nav">
      <a href="index.html" class="nav-item" data-page="home">
        <span class="nav-icon">🏠</span>
        <span class="nav-label">홈</span>
      </a>
      <a href="savings.html" class="nav-item" data-page="savings">
        <span class="nav-icon">💰</span>
        <span class="nav-label">저축</span>
      </a>
      <a href="shop.html" class="nav-item" data-page="shop">
        <span class="nav-icon">🛍️</span>
        <span class="nav-label">상점</span>
      </a>
      <a href="ranking.html" class="nav-item" data-page="ranking">
        <span class="nav-icon">🏆</span>
        <span class="nav-label">랭킹</span>
      </a>
      <a href="profile.html" class="nav-item active" data-page="profile">
        <span class="nav-icon">👤</span>
        <span class="nav-label">내정보</span>
      </a>
    </nav>

    <!-- 아바타 변경 모달 -->
    <div id="avatarModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>아바타 선택</h3>
          <button class="modal-close" onclick="closeAvatarModal()">×</button>
        </div>
        <div class="avatar-grid" id="avatarGrid">
          <!-- 아바타 옵션들이 동적으로 생성됨 -->
        </div>
      </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>비밀번호 변경</h3>
          <button class="modal-close" onclick="closePasswordModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>현재 비밀번호</label>
            <input type="password" id="currentPassword" class="form-input" />
          </div>
          <div class="form-group">
            <label>새 비밀번호</label>
            <input type="password" id="newPassword" class="form-input" />
            <span class="form-hint">4자리 이상 입력해주세요</span>
          </div>
          <div class="form-group">
            <label>새 비밀번호 확인</label>
            <input type="password" id="confirmPassword" class="form-input" />
          </div>
          <button class="btn btn-primary" onclick="updatePassword()">
            변경하기
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript 파일들 (순서 중요!) -->
    <script src="../assets/js/navigation.js"></script>
    <!-- 통일된 네비게이션 -->
    <script src="../assets/js/profile.js"></script>
    <!-- 수정된 프로필 JS -->

    <!-- 페이지 초기화 -->
    <script>
      // 네비게이션 활성 상태 설정
      document.addEventListener('DOMContentLoaded', () => {
        // 프로필 페이지 활성화는 이미 HTML에 active 클래스로 설정됨

        // 알림 클릭 핸들러
        window.handleNotificationClick = function () {
          showNotification('알림 기능은 준비 중입니다.', 'info');
        };
      });
    </script>
  </body>
</html>
