<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포인트 뱅크 - 학생</title>
    <!-- student 폴더 안의 파일들 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <!-- ../ 주의! -->

    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/student.css" />
    <link rel="stylesheet" href="../assets/css/student-main.css" />
    <!-- 🆕 네비게이션 CSS 추가 -->
    <link rel="stylesheet" href="../assets/css/navigation.css" />
  </head>
  <!-- API 및 네비게이션 스크립트 추가 -->
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/navigation.js"></script>
  <script src="../assets/js/student.js"></script>
  <script src="../assets/js/student-main.js"></script>

  <script>
    // 페이지 로드 시 포인트 즉시 업데이트
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('학생 메인 페이지 초기화');

      // 로그인 체크
      const loginId = localStorage.getItem('loginId');
      if (!loginId) {
        console.error('로그인 정보가 없습니다');
        window.location.href = '../login.html';
        return;
      }

      // 헤더 포인트 즉시 업데이트
      if (typeof updateHeaderPoints === 'function') {
        await updateHeaderPoints();
      }

      // 학생 데이터 로드 (student.js에 정의된 함수)
      if (typeof loadStudentData === 'function') {
        await loadStudentData();
      }
    });
  </script>
  <body class="with-both-nav">
    <!-- 상단 프로필 헤더 -->
    <div class="app-header">
      <div class="header-user">
        <div class="header-avatar">
          <div class="header-avatar-inner" id="userAvatar">🦁</div>
        </div>
        <div class="header-name" id="userName">학생 이름</div>
      </div>
      <div class="header-spacer"></div>
      <div class="header-actions">
        <div class="header-points" onclick="location.href='history.html'">
          <span class="header-points-icon">P</span>
          <span class="header-points-value" id="headerTotalPoints">0P</span>
          <!-- id 변경 -->
        </div>
        <div class="header-notification" onclick="handleNotificationClick()">
          <span class="notification-icon">🔔</span>
          <span class="notification-badge"></span>
        </div>
      </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="main-container">
      <!-- 포인트 카드 섹션 (클릭 가능) -->
      <div
        class="points-section"
        style="cursor: pointer"
        onclick="location.href='history.html'"
      >
        <div class="points-header">
          <div class="points-title">
            <span class="point-icon">P</span>
            <span>포인트 지갑</span>
          </div>
          <a href="history.html" class="points-link">›</a>
        </div>
        <div class="total-points" id="totalPoints">0P</div>
        <div class="points-breakdown">
          <div class="breakdown-item">
            <span class="breakdown-label">총 획득</span>
            <span class="breakdown-value" id="totalEarned">0P</span>
          </div>
          <div class="breakdown-item">
            <span class="breakdown-label">총 사용</span>
            <span class="breakdown-value" id="totalSpent">0P</span>
          </div>
        </div>
      </div>

      <!-- 탭 메뉴 -->
      <div class="tab-menu">
        <button
          class="tab-btn active"
          data-tab="overview"
          onclick="showTab('overview')"
        >
          전체
        </button>
        <button class="tab-btn" data-tab="earn" onclick="showTab('earn')">
          획득
        </button>
        <button class="tab-btn" data-tab="spend" onclick="showTab('spend')">
          사용
        </button>
        <button class="tab-btn" data-tab="save" onclick="showTab('save')">
          저축
        </button>
      </div>

      <!-- 탭 콘텐츠: 전체 -->
      <div id="overview-content" class="tab-content active">
        <!-- 저축 계좌 카드 -->
        <div
          class="savings-card"
          style="cursor: pointer"
          onclick="location.href='savings.html'"
        >
          <div class="savings-header">
            <span class="savings-title">💎 저축 계좌</span>
            <span class="interest-rate">주 2% 이자</span>
          </div>
          <div class="savings-amount" id="savingsAmount">0P</div>
          <div class="next-interest">
            다음 이자 지급일: <span id="nextInterestDate">월요일</span> (+<span
              id="expectedInterest"
              >0</span
            >P 예정)
          </div>
          <div class="savings-actions" onclick="event.stopPropagation();">
            <button class="savings-btn" onclick="location.href='savings.html'">
              입금하기
            </button>
            <button class="savings-btn" onclick="location.href='savings.html'">
              출금하기
            </button>
          </div>
        </div>

        <!-- 이벤트 타이머 -->
        <div class="event-timer">
          <div class="event-title">🎁 다음 월간 경매까지</div>
          <div class="event-countdown" id="eventCountdown">D-14</div>
          <div class="event-date" id="eventDate">11월 29일 금요일 4:30PM</div>
        </div>
      </div>

      <!-- 탭 콘텐츠: 획득 -->
      <div id="earn-content" class="tab-content">
        <div class="summary-card">
          <div class="summary-header">
            <span class="summary-title">이번 달 획득 포인트</span>
          </div>
          <div class="summary-value" style="color: #22c55e">+1,250P</div>

          <div class="mini-history">
            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #dcfce7">✅</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">출석 보상</div>
                  <div class="mini-item-date">오늘 09:00</div>
                </div>
              </div>
              <div class="mini-item-amount amount-plus">+10P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #e0e7ff">📚</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">숙제 완료</div>
                  <div class="mini-item-date">어제 17:00</div>
                </div>
              </div>
              <div class="mini-item-amount amount-plus">+30P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #fef3c7">💯</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">시험 만점</div>
                  <div class="mini-item-date">3일 전</div>
                </div>
              </div>
              <div class="mini-item-amount amount-plus">+100P</div>
            </div>
          </div>

          <button
            class="view-more-btn"
            onclick="location.href='history.html?filter=earn'"
          >
            전체 획득 내역 보기 →
          </button>
        </div>
      </div>

      <!-- 탭 콘텐츠: 사용 -->
      <div id="spend-content" class="tab-content">
        <div class="summary-card">
          <div class="summary-header">
            <span class="summary-title">이번 달 사용 포인트</span>
          </div>
          <div class="summary-value" style="color: #ef4444">-850P</div>

          <div class="mini-history">
            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #fee2e2">🛍️</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">연필 세트 구매</div>
                  <div class="mini-item-date">오늘 14:30</div>
                </div>
              </div>
              <div class="mini-item-amount amount-minus">-100P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #fee2e2">🍪</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">과자 구매</div>
                  <div class="mini-item-date">2일 전</div>
                </div>
              </div>
              <div class="mini-item-amount amount-minus">-50P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #fce7f3">🎁</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">친구 선물</div>
                  <div class="mini-item-date">5일 전</div>
                </div>
              </div>
              <div class="mini-item-amount amount-minus">-200P</div>
            </div>
          </div>

          <button
            class="view-more-btn"
            onclick="location.href='history.html?filter=spend'"
          >
            전체 사용 내역 보기 →
          </button>
        </div>
      </div>

      <!-- 탭 콘텐츠: 저축 -->
      <div id="save-content" class="tab-content">
        <div class="summary-card">
          <div class="summary-header">
            <span class="summary-title">저축 계좌 현황</span>
          </div>
          <div class="summary-value" style="color: #6366f1">2,000P</div>

          <div class="mini-history">
            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #e0e7ff">💰</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">저축 입금</div>
                  <div class="mini-item-date">3일 전</div>
                </div>
              </div>
              <div class="mini-item-amount amount-minus">-500P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #fef3c7">💎</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">이자 지급</div>
                  <div class="mini-item-date">월요일</div>
                </div>
              </div>
              <div class="mini-item-amount amount-plus">+40P</div>
            </div>

            <div class="mini-history-item">
              <div class="mini-item-left">
                <div class="mini-icon" style="background: #dcfce7">💸</div>
                <div class="mini-item-info">
                  <div class="mini-item-title">저축 출금</div>
                  <div class="mini-item-date">2주 전</div>
                </div>
              </div>
              <div class="mini-item-amount amount-plus">+1000P</div>
            </div>
          </div>

          <button class="view-more-btn" onclick="location.href='savings.html'">
            저축 계좌 관리 →
          </button>
        </div>
      </div>

      <!-- 빠른 액션 -->
      <div class="quick-actions">
        <div class="action-btn" onclick="location.href='shop.html'">
          <span class="action-icon">🛍️</span>
          <span class="action-label">포인트샵</span>
        </div>
        <div class="action-btn" onclick="showGift()">
          <span class="action-icon">🎁</span>
          <span class="action-label">친구 선물</span>
        </div>
        <div class="action-btn" onclick="showDonate()">
          <span class="action-icon">💝</span>
          <span class="action-label">기부하기</span>
        </div>
        <div class="action-btn" onclick="showMilestone()">
          <span class="action-icon">🏆</span>
          <span class="action-label">마일스톤</span>
        </div>
      </div>

      <!-- 최근 활동 -->
      <div class="activity-section">
        <div class="section-header">
          <span class="section-title">최근 포인트 활동</span>
          <a href="history.html" class="view-all">전체보기 ›</a>
        </div>
        <div class="activity-list" id="activityList">
          <div class="loading">데이터를 불러오는 중...</div>
        </div>
      </div>

      <!-- 이번 주 랭킹 -->
      <div class="ranking-card">
        <div class="section-header">
          <span class="section-title">🏆 이번 주 랭킹</span>
          <a href="ranking.html" class="view-all">전체 랭킹 ›</a>
        </div>
        <div class="ranking-list" id="rankingList">
          <div class="loading">랭킹을 불러오는 중...</div>
        </div>
      </div>

      <!-- 친구 기부 현황 -->
      <div class="donation-section">
        <div class="section-header">
          <span class="section-title">💝 이번 달 기부 천사들</span>
        </div>
        <div class="donation-list" id="donationList">
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">박민수</span>
            <span class="donor-amount">300P</span>
          </div>
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">이영희</span>
            <span class="donor-amount">200P</span>
          </div>
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">최지우</span>
            <span class="donor-amount">150P</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="app-nav">
      <div class="nav-item active" data-page="home">
        <span class="nav-icon">🏠</span>
        <span class="nav-label">홈</span>
      </div>
      <div
        class="nav-item"
        data-page="savings"
        onclick="location.href='savings.html'"
      >
        <span class="nav-icon">💰</span>
        <span class="nav-label">저축</span>
      </div>
      <div
        class="nav-item"
        data-page="shop"
        onclick="location.href='shop.html'"
      >
        <span class="nav-icon">🛍️</span>
        <span class="nav-label">상점</span>
      </div>
      <div
        class="nav-item"
        data-page="ranking"
        onclick="location.href='ranking.html'"
      >
        <span class="nav-icon">🏆</span>
        <span class="nav-label">랭킹</span>
      </div>
      <div
        class="nav-item"
        data-page="profile"
        onclick="location.href='profile.html'"
      >
        <span class="nav-icon">👤</span>
        <span class="nav-label">내정보</span>
      </div>
    </div>

    <!-- 모달: 포인트 선물 -->
    <div id="transferModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">포인트 선물하기</h2>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">받는 친구</label>
            <select class="form-select" id="recipientSelect">
              <option value="">친구를 선택하세요</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">보낼 포인트</label>
            <input
              type="number"
              class="form-input"
              id="transferAmount"
              placeholder="보낼 포인트 입력"
            />
            <div class="form-hint">
              보유 포인트: <span id="availablePoints">0</span>P
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">메시지 (선택)</label>
            <input
              type="text"
              class="form-input"
              id="transferMessage"
              placeholder="응원 메시지를 남겨보세요!"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button class="btn btn-primary" onclick="sendGift()">선물하기</button>
        </div>
      </div>
    </div>

    <!-- 모달: 기부하기 -->
    <div id="donateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>💝 포인트 기부</h2>
          <button class="modal-close" onclick="closeDonateModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">기부 종류</label>
            <select class="form-select" id="donationType">
              <option value="school">학원 발전 기부</option>
              <option value="friend">어려운 친구 돕기</option>
              <option value="charity">자선 단체 기부</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">기부 포인트</label>
            <input
              type="number"
              class="form-input"
              id="donateAmount"
              placeholder="기부할 포인트 입력"
            />
            <div class="form-hint">
              보유 포인트: <span id="donatablePoints">0</span>P
            </div>
          </div>
          <div
            style="
              background: #f0f9ff;
              border-radius: 12px;
              padding: 15px;
              margin-top: 15px;
            "
          >
            <div style="font-size: 13px; color: #0369a1">
              💡 기부 시 기부천사 명예 포인트 10%를 추가로 받습니다!
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeDonateModal()">
            취소
          </button>
          <button class="btn btn-primary" onclick="confirmDonate()">
            기부하기
          </button>
        </div>
      </div>
    </div>

    <!-- 스크립트 로드 순서 중요! -->
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/cache.js"></script>
    <script src="../assets/js/student.js"></script>
    <script src="../assets/js/student-main.js"></script>
    <!-- 🆕 네비게이션 JS 추가 -->
    <script src="../assets/js/navigation.js"></script>
  </body>
</html>
