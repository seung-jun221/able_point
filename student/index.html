<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포인트 뱅크 - 학생</title>
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/student.css" />
  </head>
  <body>
    <!-- 상단 프로필 헤더 -->
    <div class="profile-header">
      <div class="profile-left">
        <div class="avatar" id="userAvatar">🦁</div>
        <div class="profile-info">
          <h2 id="userName">학생 이름</h2>
          <span class="level-badge" id="userLevel">🌱 씨앗</span>
        </div>
      </div>
      <div class="daily-points">
        <div class="daily-label">오늘 획득</div>
        <div class="daily-value" id="todayPoints">+0P</div>
      </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div class="main-container">
      <!-- 포인트 카드 섹션 (클릭 가능) -->
      <div
        class="points-section"
        style="cursor: pointer"
        onclick="location.href='history.html'"
      >
        <div class="points-header">
          <div class="points-title">
            <span class="point-icon">P</span>
            <span>포인트 지갑</span>
          </div>
          <a href="history.html" class="points-link">›</a>
        </div>
        <div class="total-points" id="totalPoints">0P</div>
        <div class="points-breakdown">
          <div class="breakdown-item">
            <span class="breakdown-label">총 획득</span>
            <span class="breakdown-value" id="totalEarned">0P</span>
          </div>
          <div class="breakdown-item">
            <span class="breakdown-label">총 사용</span>
            <span class="breakdown-value" id="totalSpent">0P</span>
          </div>
        </div>
      </div>

      <!-- 탭 메뉴 -->
      <div class="tab-menu">
        <button
          class="tab-btn active"
          data-tab="overview"
          onclick="goToHistory('all')"
        >
          전체
        </button>
        <button class="tab-btn" data-tab="earn" onclick="goToHistory('earn')">
          획득
        </button>
        <button class="tab-btn" data-tab="spend" onclick="goToHistory('spend')">
          사용
        </button>
        <button class="tab-btn" data-tab="save" onclick="goToHistory('save')">
          저축
        </button>
      </div>

      <!-- 저축 계좌 카드 (클릭 가능) -->
      <div
        class="savings-card"
        style="cursor: pointer"
        onclick="location.href='savings.html'"
      >
        <div class="savings-header">
          <span class="savings-title">💎 저축 계좌</span>
          <span class="interest-rate">주 2% 이자</span>
        </div>
        <div class="savings-amount" id="savingsAmount">0P</div>
        <div class="next-interest">
          다음 이자 지급일: <span id="nextInterestDate">월요일</span> (+<span
            id="expectedInterest"
            >0</span
          >P 예정)
        </div>
        <div class="savings-actions" onclick="event.stopPropagation();">
          <button class="savings-btn" onclick="location.href='savings.html'">
            입금하기
          </button>
          <button class="savings-btn" onclick="location.href='savings.html'">
            출금하기
          </button>
        </div>
      </div>

      <!-- 이벤트 타이머 -->
      <div class="event-timer">
        <div class="event-title">🎁 다음 월간 경매까지</div>
        <div class="event-countdown" id="eventCountdown">D-14</div>
        <div class="event-date" id="eventDate">11월 29일 금요일 4:30PM</div>
      </div>

      <!-- 빠른 액션 -->
      <div class="quick-actions">
        <div class="action-btn" onclick="location.href='shop.html'">
          <span class="action-icon">🛍️</span>
          <span class="action-label">포인트샵</span>
        </div>
        <div class="action-btn" onclick="showGift()">
          <span class="action-icon">🎁</span>
          <span class="action-label">친구 선물</span>
        </div>
        <div class="action-btn" onclick="showDonate()">
          <span class="action-icon">💝</span>
          <span class="action-label">기부하기</span>
        </div>
        <div class="action-btn" onclick="showMilestone()">
          <span class="action-icon">🏆</span>
          <span class="action-label">마일스톤</span>
        </div>
      </div>

      <!-- 최근 활동 -->
      <div class="activity-section">
        <div class="section-header">
          <span class="section-title">최근 포인트 활동</span>
          <a href="history.html" class="view-all">전체보기 ›</a>
        </div>
        <div class="activity-list" id="activityList">
          <div class="loading">데이터를 불러오는 중...</div>
        </div>
      </div>

      <!-- 이번 주 랭킹 -->
      <div class="ranking-card">
        <div class="section-header">
          <span class="section-title">🏆 이번 주 랭킹</span>
          <a href="ranking.html" class="view-all">전체 랭킹 ›</a>
        </div>
        <div class="ranking-list" id="rankingList">
          <div class="loading">랭킹을 불러오는 중...</div>
        </div>
      </div>

      <!-- 친구 기부 현황 -->
      <div class="donation-section">
        <div class="section-header">
          <span class="section-title">💝 이번 달 기부 천사들</span>
        </div>
        <div class="donation-list" id="donationList">
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">박민수</span>
            <span class="donor-amount">300P</span>
          </div>
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">이영희</span>
            <span class="donor-amount">200P</span>
          </div>
          <div class="donor-card">
            <span class="donor-icon">👼</span>
            <span class="donor-name">최지우</span>
            <span class="donor-amount">150P</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="bottom-nav">
      <div class="nav-item active" data-page="home">
        <span class="nav-icon">🏠</span>
        <span class="nav-label">홈</span>
      </div>
      <div
        class="nav-item"
        data-page="savings"
        onclick="location.href='savings.html'"
      >
        <span class="nav-icon">💰</span>
        <span class="nav-label">저축</span>
      </div>
      <div
        class="nav-item"
        data-page="shop"
        onclick="location.href='shop.html'"
      >
        <span class="nav-icon">🛍️</span>
        <span class="nav-label">상점</span>
      </div>
      <div
        class="nav-item"
        data-page="ranking"
        onclick="location.href='ranking.html'"
      >
        <span class="nav-icon">🏆</span>
        <span class="nav-label">랭킹</span>
      </div>
      <div
        class="nav-item"
        data-page="profile"
        onclick="location.href='profile.html'"
      >
        <span class="nav-icon">👤</span>
        <span class="nav-label">내정보</span>
      </div>
    </div>

    <!-- 모달: 포인트 선물 -->
    <div id="transferModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">포인트 선물하기</h2>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">받는 친구</label>
            <select class="form-select" id="recipientSelect">
              <option value="">친구를 선택하세요</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">보낼 포인트</label>
            <input
              type="number"
              class="form-input"
              id="transferAmount"
              placeholder="보낼 포인트 입력"
            />
            <div class="form-hint">
              보유 포인트: <span id="availablePoints">0</span>P
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">메시지 (선택)</label>
            <input
              type="text"
              class="form-input"
              id="transferMessage"
              placeholder="응원 메시지를 남겨보세요!"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button class="btn btn-primary" onclick="sendGift()">선물하기</button>
        </div>
      </div>
    </div>

    <!-- 모달: 기부하기 -->
    <div id="donateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>💝 포인트 기부</h2>
          <button class="modal-close" onclick="closeDonateModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">기부 종류</label>
            <select class="form-select" id="donationType">
              <option value="school">학원 발전 기부</option>
              <option value="friend">어려운 친구 돕기</option>
              <option value="charity">자선 단체 기부</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">기부 포인트</label>
            <input
              type="number"
              class="form-input"
              id="donateAmount"
              placeholder="기부할 포인트 입력"
            />
            <div class="form-hint">
              보유 포인트: <span id="donatablePoints">0</span>P
            </div>
          </div>
          <div
            style="
              background: #f0f9ff;
              border-radius: 12px;
              padding: 15px;
              margin-top: 15px;
            "
          >
            <div style="font-size: 13px; color: #0369a1">
              💡 기부 시 기부천사 명예 포인트 10%를 추가로 받습니다!
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeDonateModal()">
            취소
          </button>
          <button class="btn btn-primary" onclick="confirmDonate()">
            기부하기
          </button>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/student.js"></script>

    <script>
      // 추가 함수들 - 페이지 연결

      // 거래 내역 페이지로 이동 (필터 적용)
      function goToHistory(filter) {
        if (filter === 'all') {
          location.href = 'history.html';
        } else {
          location.href = `history.html?filter=${filter}`;
        }
      }

      // 전체 내역 보기
      function showHistory() {
        location.href = 'history.html';
      }

      // 전체 활동 보기
      function showAllHistory() {
        location.href = 'history.html';
      }

      // 친구 선물 모달
      function showGift() {
        document.getElementById('transferModal').classList.add('active');
        // 보유 포인트 업데이트
        const currentPoints = studentData?.currentPoints || 0;
        document.getElementById('availablePoints').textContent =
          currentPoints.toLocaleString();
      }

      // 기부 모달
      function showDonate() {
        document.getElementById('donateModal').classList.add('active');
        // 보유 포인트 업데이트
        const currentPoints = studentData?.currentPoints || 0;
        document.getElementById('donatablePoints').textContent =
          currentPoints.toLocaleString();
      }

      // 기부 모달 닫기
      function closeDonateModal() {
        document.getElementById('donateModal').classList.remove('active');
        // 입력 초기화
        document.getElementById('donationType').value = 'school';
        document.getElementById('donateAmount').value = '';
      }

      // 기부 확인
      async function confirmDonate() {
        const type = document.getElementById('donationType').value;
        const amount = parseInt(document.getElementById('donateAmount').value);

        if (!amount || amount <= 0) {
          alert('기부할 포인트를 입력해주세요.');
          return;
        }

        if (amount > studentData.currentPoints) {
          alert('포인트가 부족합니다.');
          return;
        }

        const typeText = {
          school: '학원 발전',
          friend: '어려운 친구 돕기',
          charity: '자선 단체',
        };

        if (confirm(`${typeText[type]}에 ${amount}P를 기부하시겠습니까?`)) {
          // 실제로는 API 호출
          const bonusPoints = Math.floor(amount * 0.1);
          alert(
            `기부가 완료되었습니다!\n기부천사 명예 포인트 ${bonusPoints}P를 받았습니다!`
          );

          // 데이터 업데이트
          studentData.currentPoints -= amount;
          studentData.currentPoints += bonusPoints;

          closeDonateModal();
          loadStudentData(); // 화면 새로고침
        }
      }

      // 마일스톤 보기
      function showMilestone() {
        const currentTotal = studentData?.totalPoints || 0;
        const milestones = [
          { level: '🌱 씨앗', points: 0, reward: '기본' },
          { level: '🌿 새싹', points: 1000, reward: '배지' },
          { level: '🌳 나무', points: 3000, reward: '특별 배지' },
          { level: '🌲 큰나무', points: 5000, reward: '보너스 100P' },
          { level: '⭐ 별', points: 10000, reward: '보너스 500P' },
          { level: '💎 다이아몬드', points: 20000, reward: '특별 선물' },
        ];

        let currentLevel = milestones[0];
        let nextLevel = milestones[1];

        for (let i = 0; i < milestones.length; i++) {
          if (currentTotal >= milestones[i].points) {
            currentLevel = milestones[i];
            nextLevel = milestones[i + 1] || null;
          }
        }

        const message = nextLevel
          ? `현재 레벨: ${currentLevel.level}\n` +
            `누적 포인트: ${currentTotal}P\n\n` +
            `다음 레벨: ${nextLevel.level}\n` +
            `필요 포인트: ${nextLevel.points - currentTotal}P\n` +
            `달성 보상: ${nextLevel.reward}`
          : `최고 레벨 달성! ${currentLevel.level}\n누적 포인트: ${currentTotal}P`;

        alert(message);
      }

      // 프로필 보기
      function showProfile() {
        location.href = 'profile.html';
      }

      // 저축 관련 함수들 (savings.html로 이동)
      function deposit() {
        location.href = 'savings.html';
      }

      function withdraw() {
        location.href = 'savings.html';
      }

      // ESC 키로 모달 닫기
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
          closeDonateModal();
        }
      });

      // 모달 외부 클릭 시 닫기
      document.querySelectorAll('.modal').forEach((modal) => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });
    </script>
  </body>
</html>
