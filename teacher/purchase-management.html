<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>구매 관리 - 포인트 뱅크</title>

    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/teacher.css" />
    <link rel="stylesheet" href="../assets/css/purchase-management.css" />

    <!-- jQuery 먼저 로드 (toastr가 jQuery 필요) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Toastr CSS & JS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- Supabase & API -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- 사이드바 -->
      <div class="sidebar">
        <div class="sidebar-header">
          <!-- 로고 영역 -->
          <div class="logo-container">
            <div class="logo-image">
              <img src="../assets/images/able-logo.png" alt="에이블수학학원" />
            </div>
            <div class="logo-subtitle">포인트뱅크</div>
          </div>

          <!-- 반 선택 영역 -->
          <div class="class-selector-wrapper">
            <label class="class-selector-label">반 선택</label>
            <select class="class-selector" id="classSelector">
              <option value="">전체 반</option>
              <!-- 동적 로드됨 -->
            </select>
          </div>
        </div>

        <nav class="nav-menu">
          <!-- 대시보드 (모든 선생님) -->
          <div class="nav-section">
            <a href="index.html" class="nav-item">
              <span class="nav-icon">📊</span>
              <span>대시보드</span>
            </a>
          </div>

          <!-- 포인트 관리 (모든 선생님) -->
          <div class="nav-section">
            <div class="nav-section-title">포인트</div>
            <a href="index.html" class="nav-item">
              <span class="nav-icon">💰</span>
              <span>포인트 지급</span>
            </a>
            <a href="point-history.html" class="nav-item">
              <span class="nav-icon">📋</span>
              <span>지급 내역</span>
            </a>
            <a href="interest-management.html" class="nav-item">
              <span class="nav-icon">💵</span>
              <span>이자 지급</span>
            </a>
          </div>

          <!-- 상점 관리 (모든 선생님) -->
          <div class="nav-section">
            <div class="nav-section-title">상점</div>
            <a href="purchase-management.html" class="nav-item">
              <span class="nav-icon">📦</span>
              <span>구매 관리</span>
              <span class="nav-badge" id="pendingBadge" style="display: none"
                >0</span
              >
            </a>
          </div>

          <!-- 리포트 (모든 선생님) -->
          <div class="nav-section">
            <div class="nav-section-title">리포트</div>
            <a href="ranking.html" class="nav-item">
              <span class="nav-icon">🏆</span>
              <span>랭킹</span>
            </a>
            <a href="history.html" class="nav-item">
              <span class="nav-icon">📜</span>
              <span>포인트 내역</span>
            </a>
          </div>

          <!-- 관리자 전용 메뉴 (원장만 표시) -->
          <div class="nav-section" id="adminSection" style="display: none">
            <div class="nav-section-title">관리</div>
            <a href="manage.html" class="nav-item">
              <span class="nav-icon">👥</span>
              <span>선생님</span>
            </a>
            <a href="classes.html" class="nav-item">
              <span class="nav-icon">🏫</span>
              <span>반 설정</span>
            </a>
            <a href="students.html" class="nav-item">
              <span class="nav-icon">🎓</span>
              <span>학생</span>
            </a>
            <a href="shop-manage.html" class="nav-item">
              <span class="nav-icon">🛍️</span>
              <span>상품</span>
            </a>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="user-info">
            <span class="user-name" id="teacherName">선생님</span>
            <span class="user-role" id="userRole">Teacher</span>
          </div>
          <button class="logout-btn" onclick="logout()">
            <span>🚪</span>
            <span>로그아웃</span>
          </button>
        </div>
      </div>

      <!-- 메인 컨텐츠 -->
      <div class="main-content">
        <!-- 페이지 헤더 -->
        <div class="page-header">
          <div class="header-left">
            <h1 class="page-title">구매 관리</h1>
            <p class="page-subtitle">
              학생들의 상점 구매 내역을 확인하고 지급 처리합니다
            </p>
          </div>
          <div class="header-right">
            <div class="stat-cards">
              <div class="mini-stat-card urgent">
                <span class="stat-value" id="pendingCount">0</span>
                <span class="stat-label">미지급</span>
              </div>
              <div class="mini-stat-card">
                <span class="stat-value" id="todayCount">0</span>
                <span class="stat-label">오늘 처리</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 필터 바 -->
        <div class="filter-bar">
          <div class="filter-left">
            <div class="tab-group">
              <button
                class="tab-btn active"
                onclick="showTab('pending')"
                data-tab="pending"
              >
                미지급 <span class="tab-badge" id="pendingBadge2">2</span>
              </button>
              <button
                class="tab-btn"
                onclick="showTab('delivered')"
                data-tab="delivered"
              >
                지급완료
              </button>
              <button class="tab-btn" onclick="showTab('all')" data-tab="all">
                전체내역
              </button>
            </div>
          </div>

          <div class="filter-right">
            <select
              id="perPageSelector"
              class="form-select"
              onchange="changeItemsPerPage()"
            >
              <option value="20">20개씩 보기</option>
              <option value="30">30개씩 보기</option>
              <option value="50">50개씩 보기</option>
              <option value="100">100개씩 보기</option>
            </select>

            <input
              type="text"
              id="searchInput"
              class="form-input search-input"
              placeholder="학생 이름 또는 상품명 검색..."
            />

            <button
              class="btn-icon"
              onclick="refreshPurchases()"
              title="새로고침"
            >
              🔄
            </button>
          </div>
        </div>

        <!-- 테이블 컨테이너 -->
        <div class="table-container">
          <table class="data-table purchase-table">
            <thead>
              <tr>
                <th width="40">
                  <input
                    type="checkbox"
                    id="selectAll"
                    onchange="toggleSelectAll()"
                  />
                </th>
                <th width="80">상태</th>
                <th width="150">학생</th>
                <th width="120">클래스</th>
                <th>상품명</th>
                <th width="100">가격</th>
                <th width="150">구매시간</th>
                <th width="100">경과시간</th>
                <th width="120">액션</th>
              </tr>
            </thead>
            <tbody id="purchaseTableBody">
              <!-- 동적 생성 -->
            </tbody>
          </table>

          <!-- 데이터 없을 때 -->
          <div class="empty-state" id="emptyState" style="display: none">
            <div class="empty-icon">📦</div>
            <div class="empty-message">데이터가 없습니다</div>
          </div>
        </div>

        <!-- 일괄 처리 바 -->
        <div class="bulk-action-bar" id="bulkActionBar" style="display: none">
          <div class="bulk-info">
            <span class="selected-count"
              ><span id="selectedCount">0</span>개 선택됨</span
            >
          </div>
          <div class="bulk-actions">
            <button class="btn btn-primary" onclick="bulkDeliver()">
              일괄 지급 처리
            </button>
            <button class="btn btn-secondary" onclick="cancelSelection()">
              선택 취소
            </button>
          </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-wrapper">
          <div class="pagination-info">
            전체 <span id="totalItems">2</span>건 중
            <span id="showingRange">1-2</span>번째 표시
          </div>
          <div class="pagination" id="pagination">
            <!-- 동적 생성 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 지급 확인 모달 -->
    <div id="deliveryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>지급 처리</h2>
          <button class="modal-close" onclick="closeDeliveryModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="delivery-info">
            <div class="info-group">
              <label>학생 정보</label>
              <div class="student-info-card">
                <span class="student-avatar" id="modalStudentAvatar">🦁</span>
                <div>
                  <div class="student-name" id="modalStudentName">학생명</div>
                  <div class="student-class" id="modalStudentClass">클래스</div>
                </div>
              </div>
            </div>

            <div class="info-group">
              <label>상품 정보</label>
              <div class="item-info-card">
                <div class="item-name" id="modalItemName">상품명</div>
                <div class="item-price" id="modalItemPrice">0P</div>
              </div>
            </div>

            <div class="info-group">
              <label>구매 정보</label>
              <div class="purchase-info">
                <div class="info-row">
                  <span>구매 시간:</span>
                  <span id="modalPurchaseTime">-</span>
                </div>
                <div class="info-row">
                  <span>경과 시간:</span>
                  <span id="modalElapsedTime">-</span>
                </div>
              </div>
            </div>

            <div class="info-group">
              <label for="deliveryNotes">지급 메모 (선택)</label>
              <textarea
                id="deliveryNotes"
                class="form-textarea"
                placeholder="예: 데스크에서 직접 전달"
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeDeliveryModal()">
            취소
          </button>
          <button
            class="btn btn-primary"
            id="confirmDeliveryBtn"
            onclick="confirmDelivery()"
          >
            지급완료 처리
          </button>
        </div>
      </div>
    </div>

    <!-- 상세보기 모달 (deliveryModal 다음에 추가) -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>📋 구매 상세 정보</h2>
          <button class="modal-close" onclick="closeDetailModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="delivery-info">
            <!-- 학생 정보 -->
            <div class="info-group">
              <label>학생 정보</label>
              <div class="student-info-card">
                <span class="student-avatar" id="detailStudentAvatar">🦁</span>
                <div>
                  <div class="student-name" id="detailStudentName">학생명</div>
                  <div class="student-class" id="detailStudentClass">
                    클래스
                  </div>
                  <div
                    class="student-id"
                    style="font-size: 12px; color: #9ca3af"
                  >
                    ID: <span id="detailStudentId">-</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 상품 정보 -->
            <div class="info-group">
              <label>상품 정보</label>
              <div class="item-info-card">
                <div class="item-name" id="detailItemName">상품명</div>
                <div class="item-price" id="detailItemPrice">0P</div>
              </div>
            </div>

            <!-- 구매 정보 -->
            <div class="info-group">
              <label>구매 정보</label>
              <div class="purchase-info">
                <div class="info-row">
                  <span>거래 ID:</span>
                  <span
                    id="detailTransactionId"
                    style="font-family: monospace; font-size: 12px"
                    >-</span
                  >
                </div>
                <div class="info-row">
                  <span>구매 시간:</span>
                  <span id="detailPurchaseTime">-</span>
                </div>
                <div class="info-row">
                  <span>경과 시간:</span>
                  <span id="detailElapsedTime">-</span>
                </div>
              </div>
            </div>

            <!-- 지급 정보 (지급완료인 경우만 표시) -->
            <div
              class="info-group"
              id="deliveryInfoGroup"
              style="display: none"
            >
              <label>지급 정보</label>
              <div class="delivery-details">
                <div class="info-row">
                  <span>지급 상태:</span>
                  <span class="status-badge delivered">✅ 지급완료</span>
                </div>
                <div class="info-row">
                  <span>지급 처리자:</span>
                  <span id="detailDeliveredBy">-</span>
                </div>
                <div class="info-row">
                  <span>지급 시간:</span>
                  <span id="detailDeliveredAt">-</span>
                </div>
                <div
                  class="info-row"
                  id="deliveryNotesRow"
                  style="display: none"
                >
                  <span>지급 메모:</span>
                  <span
                    id="detailDeliveryNotes"
                    style="font-style: italic; color: #6b7280"
                    >-</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- 미지급인 경우만 지급 버튼 표시 -->
          <button
            class="btn btn-primary"
            id="detailDeliverBtn"
            onclick="deliverFromDetail()"
            style="display: none"
          >
            지급처리
          </button>
          <button class="btn btn-secondary" onclick="closeDetailModal()">
            닫기
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/purchase-management.js"></script>
    <script src="../assets/js/teacher-common.js"></script>
    <script>
      // 반 선택 시 해당 반 구매 요청만 표시
      window.onClassChange = function (classId) {
        if (classId) {
          loadPurchaseRequests(classId);
        } else {
          loadPurchaseRequests(); // 전체
        }
      };
    </script>
  </body>
</html>
