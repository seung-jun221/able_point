<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ν¬μΈνΈ λ±…ν¬ - μ„ μƒλ‹ κ΄€λ¦¬</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/teacher.css" />

    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
    />

    <!-- Toastr CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />

    <style>
      /* Toastr μ»¤μ¤ν„°λ§μ΄μ§• */
      .toast-success {
        background-color: #22c55e !important;
      }
      .toast-error {
        background-color: #ef4444 !important;
      }
      .toast-warning {
        background-color: #f59e0b !important;
      }
      .toast-info {
        background-color: #6366f1 !important;
      }
      #toast-container > div {
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }
    </style>
  </head>
  <body>
    <!-- μ‚¬μ΄λ“λ°” -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">π¦</div>
          <span>ν¬μΈνΈ λ±…ν¬</span>
        </div>
        <!-- HTML λ¶€λ¶„ (teacher/index.html) -->
        <!-- κΈ°μ΅΄μ ν•λ“μ½”λ”©λ selectλ¥Ό μ•„λλ΅ κµμ²΄ -->

        <select class="class-selector" id="classSelector">
          <option value="">μ „μ²΄ λ°</option>
          <!-- μµμ…μ€ JavaScriptμ—μ„ λ™μ μΌλ΅ λ΅λ“λ¨ -->
        </select>
      </div>

      <nav class="nav-menu">
        <a href="#" class="nav-item active" data-page="dashboard">
          <span class="nav-icon">π“</span>
          <span>λ€μ‹λ³΄λ“</span>
        </a>
        <a href="#" class="nav-item" data-page="students">
          <span class="nav-icon">π‘¥</span>
          <span>ν•™μƒ κ΄€λ¦¬</span>
        </a>
        <a href="#" class="nav-item" data-page="points">
          <span class="nav-icon">π’°</span>
          <span>ν¬μΈνΈ μ§€κΈ‰</span>
        </a>
        <a href="#" class="nav-item" data-page="shop">
          <span class="nav-icon">π›οΈ</span>
          <span>ν¬μΈνΈμƒµ κ΄€λ¦¬</span>
        </a>
        <a href="#" class="nav-item" data-page="events">
          <span class="nav-icon">π―</span>
          <span>μ΄λ²¤νΈ κ΄€λ¦¬</span>
        </a>
        <a href="#" class="nav-item" data-page="ranking">
          <span class="nav-icon">π†</span>
          <span>λ­ν‚Ή κ΄€λ¦¬</span>
        </a>
        <a href="#" class="nav-item" data-page="reports">
          <span class="nav-icon">π“</span>
          <span>λ¦¬ν¬νΈ</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="teacher-profile">
          <div class="teacher-avatar">π‘©β€π«</div>
          <div class="teacher-info">
            <div class="teacher-name" id="teacherName">μ„ μƒλ‹</div>
            <div class="teacher-role">λ‹΄μ„ μ„ μƒλ‹</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <span>π</span> λ΅κ·Έμ•„μ›ƒ
        </button>
      </div>
    </div>

    <!-- λ©”μΈ μ»¨ν…μΈ  -->
    <div class="main-content">
      <!-- νμ΄μ§€ ν—¤λ” -->
      <div class="page-header">
        <h1 class="page-title">λ€μ‹λ³΄λ“</h1>
        <p class="page-subtitle" id="todayDate">2024λ…„ 11μ›” 15μΌ κΈμ”μΌ</p>
      </div>

      <!-- μ”μ•½ μΉ΄λ“ -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon icon-blue">π‘¥</div>
          <div class="summary-label">μ΄ ν•™μƒ μ</div>
          <div class="summary-value" id="totalStudents">0λ…</div>
          <div class="summary-change">μ „μ²΄ ν•™μƒ</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-green">π’°</div>
          <div class="summary-label">μ¤λ λ°ν–‰ ν¬μΈνΈ</div>
          <div class="summary-value" id="todayPoints">0P</div>
          <div class="summary-change">μ¤λ μ§€κΈ‰ν• ν¬μΈνΈ</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-purple">π†</div>
          <div class="summary-label">μ΄λ² μ£Ό 1λ“±</div>
          <div class="summary-value" id="weeklyTop">-</div>
          <div class="summary-change" id="weeklyTopPoints">0P νλ“</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-orange">π―</div>
          <div class="summary-label">λ‹¤μ μ΄λ²¤νΈ</div>
          <div class="summary-value">D-14</div>
          <div class="summary-change">μ›”κ°„ κ²½λ§¤</div>
        </div>
      </div>

      <!-- λΉ λ¥Έ μ•΅μ… κ·Έλ¦¬λ“ -->
      <div class="quick-actions-grid">
        <div class="quick-action" onclick="showPointModal()">
          <div class="quick-action-icon">π’°</div>
          <div class="quick-action-label">ν¬μΈνΈ μ§€κΈ‰</div>
        </div>
        <div class="quick-action" onclick="showBulkActions()">
          <div class="quick-action-icon">π‘¥</div>
          <div class="quick-action-label">μΌκ΄„ μ²λ¦¬</div>
        </div>
        <div class="quick-action" onclick="showReports()">
          <div class="quick-action-icon">π“</div>
          <div class="quick-action-label">λ¦¬ν¬νΈ μƒμ„±</div>
        </div>
      </div>

      <!-- μΌκ΄„ μ•΅μ… μμ—­ -->
      <div
        id="bulkActionArea"
        class="bulk-action-area"
        style="display: none"
      ></div>

      <!-- ν•™μƒ ν…μ΄λΈ” μ„Ήμ… -->
      <div class="table-section">
        <div class="table-header">
          <h3 class="table-title">ν•™μƒ λ©λ΅</h3>
          <div class="table-actions">
            <input
              type="text"
              id="searchInput"
              class="search-box"
              placeholder="ν•™μƒ κ²€μƒ‰..."
            />
            <button class="btn-primary" onclick="showPointModal()">
              <span>β•</span> ν¬μΈνΈ μ§€κΈ‰
            </button>
          </div>
        </div>

        <!-- ν•™μƒ ν…μ΄λΈ” -->
        <table id="studentTable" class="student-table">
          <thead id="studentTableHead">
            <tr>
              <!-- μ²΄ν¬λ°•μ¤ μ—΄μ€ JSμ—μ„ μλ™ μ¶”κ°€λ¨ -->
              <th>μ΄λ¦„</th>
              <th>ν•™κΈ‰</th>
              <th>λ λ²¨</th>
              <th>λ³΄μ  ν¬μΈνΈ</th>
              <th>μ €μ¶•</th>
              <th>λΉ λ¥Έ μ•΅μ…</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- μ—¬κΈ°μ— ν•™μƒ λ©λ΅μ΄ λ™μ μΌλ΅ μƒμ„±λ¨ -->
          </tbody>
        </table>
      </div>

      <!-- ν¬μΈνΈ μ§€κΈ‰ λ¨λ‹¬ -->
      <div id="pointModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>ν¬μΈνΈ μ§€κΈ‰/μ°¨κ°</h2>
            <button class="modal-close" onclick="closeModal()">β•</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>λ€μƒ ν•™μƒ</label>
              <select id="modalStudentSelect" class="form-control">
                <option value="">ν•™μƒμ„ μ„ νƒν•μ„Έμ”</option>
                <option value="all">μ „μ²΄ ν•™μƒ</option>
              </select>
            </div>

            <div class="form-group">
              <label>ν¬μΈνΈ ν•­λ©</label>
              <select id="modalPointType" class="form-control">
                <!-- λ™μ μΌλ΅ μƒμ„±λ¨ -->
              </select>
            </div>

            <div class="form-group">
              <label>ν¬μΈνΈ</label>
              <input
                type="number"
                id="modalPointAmount"
                class="form-control"
                placeholder="ν¬μΈνΈλ¥Ό μ…λ ¥ν•μ„Έμ”"
              />
            </div>

            <div class="form-group">
              <label>μ‚¬μ </label>
              <input
                type="text"
                id="modalPointReason"
                class="form-control"
                placeholder="μ‚¬μ λ¥Ό μ…λ ¥ν•μ„Έμ”"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">μ·¨μ†</button>
            <button class="btn-primary" onclick="submitPoints()">ν™•μΈ</button>
          </div>
        </div>
      </div>

      <!-- μ°¨νΈ μ„Ήμ… -->
      <div
        class="charts-section"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
          margin: 30px 0;
        "
      >
        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            min-height: 300px;
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            π“ μ£Όκ°„ ν¬μΈνΈ λ°κΈ‰ ν„ν™©
          </h3>
          <canvas id="weeklyPointsChart" style="max-height: 250px"></canvas>
        </div>

        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            π¥§ ν•™μƒλ³„ ν¬μΈνΈ λ¶„ν¬
          </h3>
          <canvas id="studentDistributionChart"></canvas>
        </div>

        <!-- μ°¨νΈ μΉ΄λ“ μ¤νƒ€μΌ μμ • -->
        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            π“ μΉ΄ν…κ³ λ¦¬λ³„ ν¬μΈνΈ
          </h3>
          <div style="position: relative; height: 280px">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== μ¤ν¬λ¦½νΈ μ„Ήμ… ========== -->

    <!-- 1. Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 2. Config & API -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>

    <!-- 3. jQuery (DataTables, Toastrμ μμ΅΄μ„±) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 4. DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- 5. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 6. Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- 7. Teacher.js (λ©”μΈ λ΅μ§) -->
    <script src="../assets/js/teacher.js"></script>

    <!-- 8. μ°¨νΈ μ΄κΈ°ν™” μ¤ν¬λ¦½νΈ -->
    <script>
      // μ°¨νΈ μΈμ¤ν„΄μ¤ μ €μ¥μ©
      let chartInstances = [];

      // μ°¨νΈ μ΄κΈ°ν™” ν•¨μ
      function initCharts() {
        // κΈ°μ΅΄ μ°¨νΈκ°€ μμΌλ©΄ μ κ±°
        chartInstances.forEach((chart) => {
          if (chart) chart.destroy();
        });
        chartInstances = [];

        // 1. μ£Όκ°„ ν¬μΈνΈ λ°κΈ‰ μ°¨νΈ - ν…μ¤νΈ λ°μ΄ν„° μ¶”κ°€
        const weeklyCtx = document.getElementById('weeklyPointsChart');
        if (weeklyCtx) {
          chartInstances[0] = new Chart(weeklyCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['μ›”', 'ν™”', 'μ', 'λ©', 'κΈ'],
              datasets: [
                {
                  label: 'λ°κΈ‰ ν¬μΈνΈ',
                  data: [150, 230, 180, 290, 350], // π”½ ν…μ¤νΈ λ°μ΄ν„°
                  borderColor: 'rgb(99, 102, 241)',
                  backgroundColor: 'rgba(99, 102, 241, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // π”½ μ¶”κ°€
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value + 'P';
                    },
                  },
                },
              },
            },
          });
        }

        // 2. ν•™μƒλ³„ ν¬μΈνΈ λ¶„ν¬ μ°¨νΈ - ν…μ¤νΈ λ°μ΄ν„°
        const distributionCtx = document.getElementById(
          'studentDistributionChart'
        );
        if (distributionCtx) {
          chartInstances[1] = new Chart(distributionCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['0-500P', '500-1000P', '1000-2000P', '2000P+'],
              datasets: [
                {
                  data: [5, 8, 12, 3], // π”½ ν…μ¤νΈ λ°μ΄ν„°
                  backgroundColor: ['#fbbf24', '#34d399', '#60a5fa', '#a78bfa'],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // π”½ μ¶”κ°€
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        }

        // 3. μΉ΄ν…κ³ λ¦¬λ³„ ν¬μΈνΈ μ°¨νΈ - ν…μ¤νΈ λ°μ΄ν„°
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
          chartInstances[2] = new Chart(categoryCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['μ¶μ„', 'μ™μ ', 'μ‹ν—', 'νƒλ„', 'νΉλ³„'],
              datasets: [
                {
                  label: 'ν¬μΈνΈ',
                  data: [450, 680, 320, 150, 280], // π”½ ν…μ¤νΈ λ°μ΄ν„°
                  backgroundColor: [
                    '#6366f1',
                    '#22c55e',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6',
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // π”½ μ¶”κ°€
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value + 'P';
                    },
                  },
                },
              },
            },
          });
        }
      }

      // μ°¨νΈ μ—…λ°μ΄νΈ ν•¨μ
      function updateCharts(amount) {
        // μ£Όκ°„ μ°¨νΈ μ—…λ°μ΄νΈ
        const weeklyChart = chartInstances[0];
        if (weeklyChart) {
          const today = new Date().getDay();
          const dayIndex =
            today === 0 || today === 6
              ? 4
              : today === 1
              ? 0
              : today === 2
              ? 1
              : today === 3
              ? 2
              : today === 4
              ? 3
              : today === 5
              ? 4
              : 4;

          if (dayIndex >= 0 && dayIndex < 5) {
            weeklyChart.data.datasets[0].data[dayIndex] += amount;
            weeklyChart.update('active');
          }
        }

        // μΉ΄ν…κ³ λ¦¬ μ°¨νΈ μ—…λ°μ΄νΈ
        const categoryChart = chartInstances[2];
        if (categoryChart) {
          const categoryIndex = 4; // 'νΉλ³„' μΉ΄ν…κ³ λ¦¬
          categoryChart.data.datasets[0].data[categoryIndex] += amount;
          categoryChart.update('active');
        }
      }

      // DOM λ΅λ“ μ™„λ£ μ‹ μ°¨νΈ μ΄κΈ°ν™”
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
          initCharts();
        }, 500);
      });
    </script>
  </body>
</html>
