<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포인트 뱅크 - 선생님 관리</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/teacher.css" />

    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
    />

    <!-- Toastr CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />

    <style>
      /* Toastr 커스터마이징 */
      .toast-success {
        background-color: #22c55e !important;
      }
      .toast-error {
        background-color: #ef4444 !important;
      }
      .toast-warning {
        background-color: #f59e0b !important;
      }
      .toast-info {
        background-color: #6366f1 !important;
      }
      #toast-container > div {
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }
    </style>
  </head>
  <body>
    <!-- 사이드바 -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">🏦</div>
          <span>포인트 뱅크</span>
        </div>
        <select class="class-selector" id="classSelector">
          <option value="">전체 반</option>
        </select>
      </div>

      <nav class="nav-menu">
        <div class="nav-section" id="adminSection" style="display: none">
          <div class="nav-section-title">관리자 메뉴</div>
          <a href="manage.html" class="nav-item">
            <span>👥</span>
            <span>선생님 관리</span>
          </a>
          <a href="classes.html" class="nav-item">
            <span>🏫</span>
            <span>클래스 관리</span>
          </a>
          <a href="students.html" class="nav-item">
            <span>🎓</span>
            <span>학생 관리</span>
          </a>
          <a href="shop-manage.html" class="nav-item">
            <span>🛍️</span>
            <span>상점 관리</span>
          </a>
        </div>

        <
        <div class="nav-section">
          <div class="nav-section-title">포인트 관리</div>
          <a href="index.html" class="nav-item active">
            <span>💰</span>
            <span>포인트 지급</span>
          </a>
          <!-- 🆕 새로 추가 -->
          <a href="point-history.html" class="nav-item">
            <span>📊</span>
            <span>지급 관리</span>
          </a>
          <a href="purchase-management.html" class="nav-item">
            <span>📦</span>
            <span>구매 관리</span>
            <span class="nav-badge" id="pendingBadge" style="display: none"
              >0</span
            >
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">리포트</div>
          <a href="history.html" class="nav-item">
            <span>📜</span>
            <span>포인트 내역</span>
          </a>
          <a href="ranking.html" class="nav-item">
            <span>🏆</span>
            <span>랭킹</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <span class="user-name" id="teacherName">선생님</span>
          <span class="user-role" id="userRole">Teacher</span>
        </div>
        <button class="logout-btn" onclick="logout()">
          <span>🚪</span>
          <span>로그아웃</span>
        </button>
      </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
      <!-- 페이지 헤더 -->
      <div class="page-header">
        <h1 class="page-title">대시보드</h1>
        <p class="page-subtitle" id="todayDate">2024년 11월 15일 금요일</p>
      </div>

      <!-- 요약 카드 -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon icon-blue">👥</div>
          <div class="summary-label">총 학생 수</div>
          <div class="summary-value" id="totalStudents">0명</div>
          <div class="summary-change">전체 학생</div>
        </div>

        <div
          class="summary-card"
          style="cursor: pointer"
          onclick="location.href='point-history.html'"
        >
          <div class="summary-icon icon-green">💰</div>
          <div class="summary-label">오늘 발행 포인트</div>
          <div class="summary-value" id="todayPoints">0P</div>
          <div class="summary-change">오늘 지급한 포인트 →</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-purple">🏆</div>
          <div class="summary-label">이번 주 1등</div>
          <div class="summary-value" id="weeklyTop">-</div>
          <div class="summary-change" id="weeklyTopPoints">0P 획득</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-orange">🎯</div>
          <div class="summary-label">다음 이벤트</div>
          <div class="summary-value">D-14</div>
          <div class="summary-change">월간 경매</div>
        </div>
      </div>

      <!-- 일괄 액션 영역 -->
      <div
        id="bulkActionArea"
        class="bulk-action-area"
        style="display: none"
      ></div>

      <!-- 학생 테이블 섹션 -->
      <div class="table-section">
        <div class="table-header">
          <h3 class="table-title">학생 목록</h3>
          <div class="table-actions">
            <input
              type="text"
              id="searchInput"
              class="search-box"
              placeholder="학생 이름 검색..."
            />
            <button class="btn-point-add" onclick="showPointModal()">
              <span>➕</span> 포인트 지급
            </button>
          </div>
        </div>

        <!-- 학생 테이블 -->
        <table id="studentTable" class="student-table">
          <thead id="studentTableHead">
            <tr>
              <!-- 체크박스 열은 JS에서 자동 추가됨 -->
              <th>이름</th>
              <th>학급</th>
              <th>레벨</th>
              <th>보유 포인트</th>
              <th>저축</th>
              <th>빠른 액션</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- 여기에 학생 목록이 동적으로 생성됨 -->
          </tbody>
        </table>
      </div>

      <!-- 포인트 지급 모달 -->
      <div id="pointModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>포인트 지급/차감</h2>
            <button class="modal-close" onclick="closeModal()">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>대상 학생</label>
              <select id="modalStudentSelect" class="form-control">
                <option value="">학생을 선택하세요</option>
                <option value="all">전체 학생</option>
              </select>
            </div>

            <div class="form-group">
              <label>포인트 항목</label>
              <select id="modalPointType" class="form-control">
                <!-- 동적으로 생성됨 -->
              </select>
            </div>

            <div class="form-group">
              <label>포인트</label>
              <input
                type="number"
                id="modalPointAmount"
                class="form-control"
                placeholder="0"
                min="-9999"
                max="9999"
              />
              <div class="form-hint">양수는 지급, 음수는 차감</div>
            </div>

            <div class="form-group">
              <label>사유</label>
              <input
                type="text"
                id="modalPointReason"
                class="form-control"
                placeholder="사유를 입력하세요"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">취소</button>
            <button class="btn-primary" onclick="submitPoints()">확인</button>
          </div>
        </div>
      </div>

      <!-- 차트 섹션 -->
      <div
        class="charts-section"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
          margin: 30px 0;
        "
      >
        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            min-height: 300px;
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            📊 주간 포인트 발급 현황
          </h3>
          <canvas id="weeklyPointsChart" style="max-height: 250px"></canvas>
        </div>

        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            🥧 학생별 포인트 분포
          </h3>
          <canvas id="studentDistributionChart"></canvas>
        </div>

        <!-- 차트 카드 스타일 수정 -->
        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: 350px;
            position: relative;
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            📈 카테고리별 포인트
          </h3>
          <div style="position: relative; height: 280px">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== 스크립트 섹션 ========== -->

    <!-- 1. Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 2. Config & API -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>

    <!-- 3. jQuery (DataTables, Toastr의 의존성) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 4. DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- 5. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 6. Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- 7. Teacher.js (메인 로직) -->
    <script src="../assets/js/teacher.js"></script>

    <!-- 8. 차트 초기화 스크립트 -->
    <script>
      // 차트 인스턴스 저장용
      let chartInstances = [];

      // 차트 초기화 함수
      function initCharts() {
        // 기존 차트가 있으면 제거
        chartInstances.forEach((chart) => {
          if (chart) chart.destroy();
        });
        chartInstances = [];

        // 1. 주간 포인트 발급 차트 - 테스트 데이터 추가
        const weeklyCtx = document.getElementById('weeklyPointsChart');
        if (weeklyCtx) {
          chartInstances[0] = new Chart(weeklyCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['월', '화', '수', '목', '금'],
              datasets: [
                {
                  label: '발급 포인트',
                  data: [150, 230, 180, 290, 350], // 🔽 테스트 데이터
                  borderColor: 'rgb(99, 102, 241)',
                  backgroundColor: 'rgba(99, 102, 241, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // 🔽 추가
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value + 'P';
                    },
                  },
                },
              },
            },
          });
        }

        // 2. 학생별 포인트 분포 차트 - 테스트 데이터
        const distributionCtx = document.getElementById(
          'studentDistributionChart'
        );
        if (distributionCtx) {
          chartInstances[1] = new Chart(distributionCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['0-500P', '500-1000P', '1000-2000P', '2000P+'],
              datasets: [
                {
                  data: [5, 8, 12, 3], // 🔽 테스트 데이터
                  backgroundColor: ['#fbbf24', '#34d399', '#60a5fa', '#a78bfa'],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // 🔽 추가
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        }

        // 3. 카테고리별 포인트 차트 - 테스트 데이터
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
          chartInstances[2] = new Chart(categoryCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['출석', '숙제', '시험', '태도', '특별'],
              datasets: [
                {
                  label: '포인트',
                  data: [450, 680, 320, 150, 280], // 🔽 테스트 데이터
                  backgroundColor: [
                    '#6366f1',
                    '#22c55e',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6',
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false, // 🔽 추가
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value + 'P';
                    },
                  },
                },
              },
            },
          });
        }
      }

      // 차트 업데이트 함수
      function updateCharts(amount) {
        // 주간 차트 업데이트
        const weeklyChart = chartInstances[0];
        if (weeklyChart) {
          const today = new Date().getDay();
          const dayIndex =
            today === 0 || today === 6
              ? 4
              : today === 1
              ? 0
              : today === 2
              ? 1
              : today === 3
              ? 2
              : today === 4
              ? 3
              : today === 5
              ? 4
              : 4;

          if (dayIndex >= 0 && dayIndex < 5) {
            weeklyChart.data.datasets[0].data[dayIndex] += amount;
            weeklyChart.update('active');
          }
        }

        // 카테고리 차트 업데이트
        const categoryChart = chartInstances[2];
        if (categoryChart) {
          const categoryIndex = 4; // '특별' 카테고리
          categoryChart.data.datasets[0].data[categoryIndex] += amount;
          categoryChart.update('active');
        }
      }

      // DOM 로드 완료 시 차트 초기화
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
          initCharts();
        }, 500);
      });
    </script>
  </body>
</html>
