<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포인트 뱅크 - 선생님 관리</title>
    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="../assets/css/teacher.css" />
    <!-- teacher 폴더 안의 파일 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <!-- ../ 주의! -->
    <script src="../assets/js/api.js"></script>
    <!-- ../ 주의! -->

    <!-- ⭐ 새로 추가: DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css"
    />

    <!-- ⭐ 새로 추가: Toastr (알림) CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />

    <style>
      /* Toastr 커스터마이징 */
      .toast-success {
        background-color: #22c55e !important;
      }

      .toast-error {
        background-color: #ef4444 !important;
      }

      .toast-warning {
        background-color: #f59e0b !important;
      }

      .toast-info {
        background-color: #6366f1 !important;
      }

      #toast-container > div {
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }
    </style>
  </head>
  <body>
    <!-- 사이드바 -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">🏦</div>
          <span>포인트 뱅크</span>
        </div>
        <select class="class-selector" id="classSelector">
          <option value="">전체 반</option>
          <option value="4A">초등 4-A반</option>
          <option value="4B">초등 4-B반</option>
          <option value="5A">초등 5-A반</option>
          <option value="6A">초등 6-A반</option>
        </select>
      </div>

      <nav class="nav-menu">
        <a href="#" class="nav-item active" data-page="dashboard">
          <span class="nav-icon">📊</span>
          <span>대시보드</span>
        </a>
        <a href="#" class="nav-item" data-page="students">
          <span class="nav-icon">👥</span>
          <span>학생 관리</span>
        </a>
        <a href="#" class="nav-item" data-page="points">
          <span class="nav-icon">💰</span>
          <span>포인트 지급</span>
        </a>
        <a href="#" class="nav-item" data-page="shop">
          <span class="nav-icon">🛍️</span>
          <span>포인트샵 관리</span>
        </a>
        <a href="#" class="nav-item" data-page="events">
          <span class="nav-icon">🎯</span>
          <span>이벤트 관리</span>
        </a>
        <a href="#" class="nav-item" data-page="ranking">
          <span class="nav-icon">🏆</span>
          <span>랭킹 관리</span>
        </a>
        <a href="#" class="nav-item" data-page="reports">
          <span class="nav-icon">📈</span>
          <span>리포트</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="teacher-profile">
          <div class="teacher-avatar">👩‍🏫</div>
          <div class="teacher-info">
            <div class="teacher-name" id="teacherName">선생님</div>
            <div class="teacher-role">담임 선생님</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <span>🚪</span> 로그아웃
        </button>
      </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
      <!-- 페이지 헤더 -->
      <div class="page-header">
        <h1 class="page-title">대시보드</h1>
        <p class="page-subtitle" id="todayDate">2024년 11월 15일 금요일</p>
      </div>

      <!-- 요약 카드 -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon icon-blue">👥</div>
          <div class="summary-label">총 학생 수</div>
          <div class="summary-value" id="totalStudents">0명</div>
          <div class="summary-change">전체 학생</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-green">💰</div>
          <div class="summary-label">오늘 발행 포인트</div>
          <div class="summary-value" id="todayPoints">0P</div>
          <div class="summary-change">오늘 지급한 포인트</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-purple">🏆</div>
          <div class="summary-label">이번 주 1등</div>
          <div class="summary-value" id="weeklyTop">-</div>
          <div class="summary-change" id="weeklyTopPoints">0P 획득</div>
        </div>

        <div class="summary-card">
          <div class="summary-icon icon-orange">🎯</div>
          <div class="summary-label">다음 이벤트</div>
          <div class="summary-value">D-14</div>
          <div class="summary-change">월간 경매</div>
        </div>
      </div>

      <!-- 빠른 액션 -->
      <div class="quick-actions-grid">
        <div class="quick-action" onclick="quickAction('attendance')">
          <div class="quick-action-icon">✅</div>
          <div class="quick-action-label">출석 포인트 지급</div>
        </div>
        <div class="quick-action" onclick="quickAction('test')">
          <div class="quick-action-icon">📝</div>
          <div class="quick-action-label">시험 점수 입력</div>
        </div>
        <div class="quick-action" onclick="quickAction('homework')">
          <div class="quick-action-icon">📚</div>
          <div class="quick-action-label">숙제 포인트</div>
        </div>
        <div class="quick-action" onclick="quickAction('interest')">
          <div class="quick-action-icon">💎</div>
          <div class="quick-action-label">이자 정산</div>
        </div>
      </div>

      <!-- ⭐ 새로 추가: 차트 섹션 -->
      <div
        class="charts-section"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
          margin: 30px 0;
        "
      >
        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            📊 주간 포인트 발급 현황
          </h3>
          <canvas id="weeklyPointsChart"></canvas>
        </div>

        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            🥧 학생별 포인트 분포
          </h3>
          <canvas id="studentDistributionChart"></canvas>
        </div>

        <div
          class="chart-card"
          style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
          "
        >
          <h3 style="font-size: 16px; margin-bottom: 20px; color: #333">
            📈 카테고리별 포인트
          </h3>
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <!-- 학생 목록 테이블 -->
      <div class="table-section">
        <div class="table-header">
          <h2 class="table-title">학생 포인트 현황</h2>
          <div class="table-actions">
            <input
              type="text"
              class="search-box"
              id="searchInput"
              placeholder="학생 검색..."
            />
            <button class="btn btn-primary" onclick="showPointModal()">
              포인트 지급
            </button>
          </div>
        </div>

        <table class="student-table" id="studentTable">
          <thead>
            <tr>
              <th>학생</th>
              <th>반</th>
              <th>레벨</th>
              <th>현재 포인트</th>
              <th>저축 포인트</th>
              <th>빠른 지급</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px">
                데이터를 불러오는 중...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 포인트 정책 기반 지급 모달 -->
    <div id="pointModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>포인트 지급/차감</h2>
          <button class="modal-close" onclick="closeModal()">×</button>
        </div>

        <!-- 학년 선택 -->
        <div class="form-group">
          <label class="form-label">학년 구분</label>
          <select
            class="form-select"
            id="modalGradeSelect"
            onchange="updatePointOptions()"
          >
            <option value="elementary">초등학생</option>
            <option value="middle">중학생</option>
          </select>
        </div>

        <!-- 대상 학생 -->
        <div class="form-group">
          <label class="form-label">대상 학생</label>
          <select class="form-select" id="modalStudentSelect">
            <option value="">학생을 선택하세요</option>
          </select>
        </div>

        <!-- 포인트 카테고리 -->
        <div class="form-group">
          <label class="form-label">카테고리</label>
          <select
            class="form-select"
            id="modalCategorySelect"
            onchange="updatePointTypes()"
          >
            <option value="earn">획득 포인트</option>
            <option value="penalty">차감 포인트</option>
          </select>
        </div>

        <!-- 포인트 종류 -->
        <div class="form-group">
          <label class="form-label">포인트 종류</label>
          <select
            class="form-select"
            id="modalPointType"
            onchange="autoFillPoints()"
          >
            <!-- 옵션은 JavaScript로 동적 생성 -->
          </select>
        </div>

        <!-- 포인트 금액 -->
        <div class="form-group">
          <label class="form-label">포인트 금액</label>
          <input
            type="number"
            class="form-input"
            id="modalPointAmount"
            placeholder="자동으로 입력됩니다"
          />
        </div>

        <!-- 사유 -->
        <div class="form-group">
          <label class="form-label">추가 사유 (선택)</label>
          <input
            type="text"
            class="form-input"
            id="modalPointReason"
            placeholder="예: 수학 시험 만점"
          />
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button class="btn btn-primary" onclick="submitPoints()">
            지급/차감
          </button>
        </div>
      </div>
    </div>

    <!-- 일괄 처리 모달 -->
    <div id="batchModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>일괄 포인트 처리</h2>
          <button class="modal-close" onclick="closeBatchModal()">×</button>
        </div>

        <div class="form-group">
          <label class="form-label">대상</label>
          <select class="form-select" id="batchTarget">
            <option value="all">전체 학생</option>
            <option value="elementary">초등학생 전체</option>
            <option value="middle">중학생 전체</option>
            <option value="class">특정 반</option>
          </select>
        </div>

        <div class="form-group" id="classSelectGroup" style="display: none">
          <label class="form-label">반 선택</label>
          <select class="form-select" id="batchClass">
            <option value="4A">초등 4-A반</option>
            <option value="4B">초등 4-B반</option>
            <option value="5A">초등 5-A반</option>
            <option value="6A">초등 6-A반</option>
            <option value="1A">중등 1-A반</option>
            <option value="2A">중등 2-A반</option>
            <option value="3A">중등 3-A반</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">포인트 유형</label>
          <select class="form-select" id="batchType">
            <option value="homework">과제 완료 (초등 100P, 중등 200P)</option>
            <option value="mathPerfect">연산 만점 (초등 50P)</option>
            <option value="attendance">출석 체크 (10P)</option>
            <option value="custom">직접 입력</option>
          </select>
        </div>

        <div class="form-group" id="customPointGroup" style="display: none">
          <label class="form-label">포인트 금액</label>
          <input
            type="number"
            class="form-input"
            id="batchAmount"
            placeholder="포인트 입력"
          />
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeBatchModal()">
            취소
          </button>
          <button class="btn btn-primary" onclick="processBatch()">
            일괄 처리
          </button>
        </div>
      </div>
    </div>

    <script>
      // 포인트 정책 옵션 업데이트
      function updatePointOptions() {
        const grade = document.getElementById('modalGradeSelect').value;
        const category = document.getElementById('modalCategorySelect').value;
        updatePointTypes();
      }

      function updatePointTypes() {
        const grade = document.getElementById('modalGradeSelect').value;
        const category = document.getElementById('modalCategorySelect').value;
        const typeSelect = document.getElementById('modalPointType');

        typeSelect.innerHTML = '';

        if (category === 'earn') {
          if (grade === 'elementary') {
            typeSelect.innerHTML = `
        <option value="mathPerfect" data-points="50">연산 만점 (+50P)</option>
        <option value="tamdalSite" data-points="">탐달 사고력 (실제 포인트 그대로)</option>
        <option value="homework" data-points="100">과제 완료 (+100P)</option>
        <option value="levelTest" data-points="200">등급유지테스트 통과 (+200P)</option>
        <option value="writingExcellent" data-points="300">서술형 우수자 (+300P)</option>
        <option value="tantanComplete" data-points="300">탄탄북 완료 (+300P)</option>
        <option value="onlineComplete" data-points="500">온라인 문제풀이 완료 (+500P)</option>
        <option value="makeupWork" data-points="200">결석분 가정학습 (+200P)</option>
        <option value="friendRecommend" data-points="10000">신규생 친구 추천 (+10000P)</option>
        <option value="returnRecommend" data-points="30000">퇴원생 재등원 추천 (+30000P)</option>
        <option value="teacherSpecial" data-points="">선생님 재량 특별포인트 (10-50P)</option>
      `;
          } else {
            typeSelect.innerHTML = `
        <option value="homework" data-points="200">과제 완료 (+200P)</option>
        <option value="levelTest" data-points="500">등급유지테스트 통과 (+500P)</option>
        <option value="writingExcellent" data-points="300">서술형 우수자 (+300P)</option>
        <option value="onlineComplete" data-points="1000">온라인 문제풀이 완료 (+1000P)</option>
        <option value="makeupWork" data-points="200">결석분 가정학습 (+200P)</option>
        <option value="friendRecommend" data-points="10000">신규생 친구 추천 (+10000P)</option>
        <option value="returnRecommend" data-points="30000">퇴원생 재등원 추천 (+30000P)</option>
        <option value="teacherSpecial" data-points="">선생님 재량 특별포인트 (10-50P)</option>
      `;
          }
        } else {
          if (grade === 'elementary') {
            typeSelect.innerHTML = `
        <option value="noBook" data-points="-200">책 미지참 (-200P)</option>
        <option value="noHomework" data-points="-500">과제 미제출 (-500P)</option>
        <option value="badHomework" data-points="-300">과제 불성실 50% 이상 오답 (-300P)</option>
        <option value="mathTimeout" data-points="-50">연산 시간 초과 5분 (-50P)</option>
        <option value="behaviorWarning" data-points="">태도 문제 경고 (재량)</option>
      `;
          } else {
            typeSelect.innerHTML = `
        <option value="noBook" data-points="-300">책 미지참 (-300P)</option>
        <option value="noHomework" data-points="-500">과제 미제출 (-500P)</option>
        <option value="badHomework" data-points="-300">과제 불성실 50% 이상 오답 (-300P)</option>
        <option value="behaviorWarning" data-points="">태도 문제 경고 (재량)</option>
      `;
          }
        }
      }

      function autoFillPoints() {
        const typeSelect = document.getElementById('modalPointType');
        const selectedOption = typeSelect.options[typeSelect.selectedIndex];
        const points = selectedOption.getAttribute('data-points');

        if (points) {
          document.getElementById('modalPointAmount').value = Math.abs(points);
        } else {
          document.getElementById('modalPointAmount').value = '';
          document.getElementById('modalPointAmount').placeholder =
            '직접 입력하세요';
        }
      }

      // 일괄 처리 대상 변경
      document
        .getElementById('batchTarget')
        ?.addEventListener('change', (e) => {
          const classGroup = document.getElementById('classSelectGroup');
          if (e.target.value === 'class') {
            classGroup.style.display = 'block';
          } else {
            classGroup.style.display = 'none';
          }
        });

      // 일괄 처리 유형 변경
      document.getElementById('batchType')?.addEventListener('change', (e) => {
        const customGroup = document.getElementById('customPointGroup');
        if (e.target.value === 'custom') {
          customGroup.style.display = 'block';
        } else {
          customGroup.style.display = 'none';
        }
      });

      function closeBatchModal() {
        document.getElementById('batchModal').classList.remove('active');
      }

      // 페이지 로드시 초기 옵션 설정
      document.addEventListener('DOMContentLoaded', () => {
        updatePointTypes();
      });
    </script>

    <!-- ⭐ 스크립트 순서 중요! -->
    <!-- jQuery 먼저 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 그 다음 DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- 기존 스크립트 -->
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/teacher.js"></script>

    <!-- ⭐ 차트 초기화 스크립트 -->
    <script>
      // DataTables 한글 설정
      const dataTableKorean = {
        lengthMenu: '_MENU_ 명씩 보기',
        zeroRecords: '데이터가 없습니다',
        info: '전체 _TOTAL_명 중 _START_~_END_',
        infoEmpty: '데이터가 없습니다',
        infoFiltered: '(전체 _MAX_명 중 검색)',
        search: '검색:',
        paginate: {
          first: '처음',
          last: '마지막',
          next: '다음',
          previous: '이전',
        },
      };

      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', function () {
        // DataTables 초기화 (테이블에 데이터가 있을 때만)
        setTimeout(() => {
          if ($.fn.DataTable && $('#studentTableBody tr').length > 1) {
            $('#studentTable').DataTable({
              language: dataTableKorean,
              pageLength: 10,
              order: [[3, 'desc']], // 포인트 기준 정렬
              responsive: true,
            });
          }
        }, 1000);

        // 차트 초기화
        initCharts();
      });

      // 차트 초기화 함수
      function initCharts() {
        // 1. 주간 포인트 발급 차트
        const weeklyCtx = document
          .getElementById('weeklyPointsChart')
          .getContext('2d');
        new Chart(weeklyCtx, {
          type: 'line',
          data: {
            labels: ['월', '화', '수', '목', '금'],
            datasets: [
              {
                label: '발급 포인트',
                data: [120, 190, 300, 250, 420],
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + 'P';
                  },
                },
              },
            },
          },
        });

        // 2. 학생별 포인트 분포 차트
        const distributionCtx = document
          .getElementById('studentDistributionChart')
          .getContext('2d');
        new Chart(distributionCtx, {
          type: 'doughnut',
          data: {
            labels: ['0-500P', '500-1000P', '1000-2000P', '2000P+'],
            datasets: [
              {
                data: [8, 12, 15, 5],
                backgroundColor: ['#fbbf24', '#34d399', '#60a5fa', '#a78bfa'],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
              },
            },
          },
        });

        // 3. 카테고리별 포인트 차트
        const categoryCtx = document
          .getElementById('categoryChart')
          .getContext('2d');
        new Chart(categoryCtx, {
          type: 'bar',
          data: {
            labels: ['출석', '숙제', '시험', '태도', '특별'],
            datasets: [
              {
                label: '포인트',
                data: [300, 450, 200, 150, 100],
                backgroundColor: [
                  '#6366f1',
                  '#22c55e',
                  '#f59e0b',
                  '#ef4444',
                  '#8b5cf6',
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return value + 'P';
                  },
                },
              },
            },
          },
        });
      }

      // 차트 업데이트 함수 (teacher.js에서 호출용)
      function updateCharts() {
        // 실제 데이터로 차트 업데이트
        const charts = Chart.instances;

        if (charts[0]) {
          // 주간 차트 업데이트
          const today = new Date().getDay();
          const dayIndex = today === 0 ? 4 : today - 1;
          if (dayIndex >= 0 && dayIndex < 5) {
            charts[0].data.datasets[0].data[dayIndex] += 10;
            charts[0].update();
          }
        }
      }
    </script>
    <!-- 기존 스크립트들 아래에 추가 -->
    <!-- DataTables Buttons Extension (엑셀 다운로드용) -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  </body>
</html>
